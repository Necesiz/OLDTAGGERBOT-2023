import os, logging, asyncio
from Plugins import Maho
from telethon import events, Button
from telethon.sessions import StringSession
from telethon.tl.types import ChannelParticipantsAdmins
from Configs import *
from asyncio import sleep
import time, random 

# Silmeyiniz. 
anlik_calisan = []
rxyzdev_tagTot = {}
rxyzdev_initT = {}

@Maho.on(events.NewMessage(pattern="^/cancel$"))
async def cancel_spam(event):
  if not event.chat_id in anlik_calisan:
    return
  else:
    try:
      anlik_calisan.remove(event.chat_id)
    except:
      pass
    return await event.respond('âœ… Tag prosesi baÅŸarÄ±yla dayandÄ±rÄ±ldÄ±.')

# Bayraklarla tag komutu. 
@Maho.on(events.NewMessage(pattern="^/btag ?(.*)"))
async def mentionall(event):
  rxyzdev_tagTot[event.chat_id] = 0
  if event.is_private:
    return await event.respond("Bu É™mri sadÉ™cÉ™ qrub vÉ™ya kanallarda edÉ™ bilÉ™rsiz.")
  
  admins = []
  async for admin in Maho.iter_participants(event.chat_id, filter=ChannelParticipantsAdmins):
    admins.append(admin.id)
  if not event.sender_id in admins:
    return await event.respond("**Bu É™mri sadÉ™cÉ™ yÃ¶nÉ™ticilÉ™r kullanabilir.**")
  
  if event.pattern_match.group(1):
    mode = "text_on_cmd"
    msg = event.pattern_match.group(1)
  elif event.reply_to_msg_id:
    mode = "text_on_reply"
    msg = event.reply_to_msg_id
    if msg == None:
        return await event.respond("__KÃ¶hnÉ™ Mesajlar Ã¼Ã§Ã¼n KullanÄ±cÄ±lardan BÉ™hsedÉ™nmÉ™rÉ™m! (qruba É™lavÉ™ etmÉ™dÉ™n Ã¶ncÉ™ gÃ¶ndÉ™rilÉ™n mesajlar)__")
  elif event.pattern_match.group(1) and event.reply_to_msg_id:
    return await event.respond("MÉ™nÉ™ bir mÉ™tin verin.")
  else:
    return await event.respond("**Tag BaÅŸlamaq Ã¼Ã§Ã¼n sÉ™bÉ™b yazÄ±n... âœ‹\n\n(MÉ™sÉ™lÉ™n: /btag Salam!)**")
  
  if mode == "text_on_cmd":
    anlik_calisan.append(event.chat_id)
    usrnum = 0
    usrtxt = ""
    await event.respond("**âœ… Tag prosesi baÅŸladÄ±.**")
        
    async for x in Maho.iter_participants(event.chat_id, aggressive=False):
      rxyzdev_tagTot[event.chat_id] += 1
      usrnum += 1
      usrtxt += f"[{random.choice(bayrak)}](tg://user?id={x.id}),"
      if event.chat_id not in anlik_calisan:
        return
      if usrnum == 6:
        await Maho.send_message(event.chat_id, f"ğŸ“¢ ~ **{msg}**\n{usrtxt}")
        await asyncio.sleep(3)
        usrnum = 0
        usrtxt = ""
        
    sender = await event.get_sender()
    rxyzdev_initT = f"[{sender.first_name}](tg://user?id={sender.id})"      
    if event.chat_id in rxyzdev_tagTot:
           a = await event.respond(f"**âœ… Tag prosesi baÅŸarÄ±yla dayandÄ±rÄ±ldÄ±.**\n\n** Tag edilÉ™n KiÅŸi SayÄ±sÄ±:** {rxyzdev_tagTot[event.chat_id]}")
           await sleep(10)
           await a.delete()

  if mode == "text_on_reply":
    anlik_calisan.append(event.chat_id)
 
    usrnum = 0
    usrtxt = ""
    async for x in Maho.iter_participants(event.chat_id, aggressive=False):
      rxyzdev_tagTot[event.chat_id] += 1
      usrnum += 1
      usrtxt += f"[{random.choice(bayrak)}](tg://user?id={x.id})"
      if event.chat_id not in anlik_calisan:
        return
      if usrnum == 6:
        await Maho.send_message(event.chat_id, usrtxt, reply_to=msg)
        await asyncio.sleep(3)
        usrnum = 0
        usrtxt = ""
     
    sender = await event.get_sender()
    rxyzdev_initT = f"[{sender.first_name}](tg://user?id={sender.id})"      
    if event.chat_id in rxyzdev_tagTot:
           a = await event.respond(f"**âœ… Tag prosesi baÅŸarÄ±yla dayandÄ±rÄ±ldÄ±.**\n\n**Tag edilÉ™n KiÅŸi SayÄ±sÄ±:** {rxyzdev_tagTot[event.chat_id]}")
           await sleep(10)
           await a.delete()

# Bayrak ile Tag iÅŸlemi AÅŸaÄŸÄ±daki gibidir.

bayrak = "ğŸ³ï¸â€ğŸŒˆ ğŸ³ï¸â€âš§ï¸ ğŸ‡ºğŸ‡³ ğŸ‡¦ğŸ‡« ğŸ‡¦ğŸ‡½ ğŸ‡¦ğŸ‡± ğŸ‡©ğŸ‡¿ ğŸ‡¦ğŸ‡¸ ğŸ‡¦ğŸ‡© ğŸ‡¦ğŸ‡´ ğŸ‡¦ğŸ‡® ğŸ‡¦ğŸ‡¶ ğŸ‡¦ğŸ‡¬ ğŸ‡¦ğŸ‡· ğŸ‡¦ğŸ‡¼ ğŸ‡¦ğŸ‡º ğŸ‡¦ğŸ‡¹ ğŸ‡¦ğŸ‡¿ ğŸ‡§ğŸ‡¸ ğŸ‡§ğŸ‡­ ğŸ‡§ğŸ‡©  ğŸ‡§ğŸ‡§ ğŸ‡§ğŸ‡¾ ğŸ‡§ğŸ‡ª ğŸ‡§ğŸ‡¿ ğŸ‡§ğŸ‡¯ ğŸ‡§ğŸ‡· ğŸ‡§ğŸ‡¼ ğŸ‡§ğŸ‡¦ ğŸ‡§ğŸ‡´ ğŸ‡§ğŸ‡¹ ğŸ‡§ğŸ‡² ğŸ‡»ğŸ‡¬ ğŸ‡§ğŸ‡³ ğŸ‡§ğŸ‡¬ ğŸ‡§ğŸ‡« ğŸ‡§ğŸ‡® ğŸ‡°ğŸ‡­ ğŸ‡°ğŸ‡¾ ğŸ‡§ğŸ‡¶ ğŸ‡¨ğŸ‡» ğŸ‡®ğŸ‡¨ ğŸ‡¨ğŸ‡¦ ğŸ‡¨ğŸ‡² ğŸ‡¨ğŸ‡« ğŸ‡¹ğŸ‡© ğŸ‡®ğŸ‡´ ğŸ‡¨ğŸ‡³ ğŸ‡¨ğŸ‡± ğŸ‡¨ğŸ‡½ ğŸ‡¨ğŸ‡° ğŸ‡¨ğŸ‡© ğŸ‡¨ğŸ‡¬ ğŸ‡°ğŸ‡² ğŸ‡¨ğŸ‡´ ğŸ‡¨ğŸ‡¨ ğŸ‡¨ğŸ‡· ğŸ‡¨ğŸ‡¿ ğŸ‡ªğŸ‡¬ ğŸ‡ªğŸ‡¹ ğŸ‡ªğŸ‡º ğŸ‡¸ğŸ‡» ğŸ‡©ğŸ‡° ğŸ‡¨ğŸ‡® ğŸ‡­ğŸ‡· ğŸ‡¨ğŸ‡º ğŸ‡¨ğŸ‡¼ ğŸ‡¨ğŸ‡¾ ğŸ‡ªğŸ‡¨ ğŸ‡©ğŸ‡´ ğŸ‡©ğŸ‡² ğŸ‡©ğŸ‡¯ ğŸ‡¬ğŸ‡¶ ğŸ‡ªğŸ‡· ğŸ‡«ğŸ‡´ ğŸ‡«ğŸ‡° ğŸ‡«ğŸ‡¯ ğŸ‡ªğŸ‡ª ğŸ‡¸ğŸ‡¿ ğŸ‡«ğŸ‡® ğŸ‡¬ğŸ‡² ğŸ‡¬ğŸ‡¦ ğŸ‡¹ğŸ‡« ğŸ‡µğŸ‡« ğŸ‡¬ğŸ‡« ğŸ‡«ğŸ‡· ğŸ‡¬ğŸ‡ª ğŸ‡©ğŸ‡ª ğŸ‡¬ğŸ‡­ ğŸ‡¬ğŸ‡® ğŸ‡¬ğŸ‡· ğŸ‡¬ğŸ‡± ğŸ‡¬ğŸ‡³ ğŸ‡¬ğŸ‡¬ ğŸ‡¬ğŸ‡¹ ğŸ‡¬ğŸ‡º ğŸ‡¬ğŸ‡µ ğŸ‡¬ğŸ‡© ğŸ‡¬ğŸ‡¼ ğŸ‡¬ğŸ‡¾ ğŸ‡­ğŸ‡¹ ğŸ‡­ğŸ‡³ ğŸ‡­ğŸ‡° ğŸ‡­ğŸ‡º ğŸŒ ğŸ‡®ğŸ‡ª ğŸ‡®ğŸ‡¶ ğŸ‡¯ğŸ‡µ ğŸ‡¯ğŸ‡² ğŸ‡®ğŸ‡· ğŸ‡®ğŸ‡© ğŸ‡®ğŸ‡¹ ğŸ‡®ğŸ‡± ğŸ‡®ğŸ‡³ ğŸ‡®ğŸ‡¸ ğŸ‡®ğŸ‡² ğŸ‡¯ğŸ‡ª ğŸ‡¯ğŸ‡´ ğŸ‡°ğŸ‡¬ ğŸ‡°ğŸ‡¼ ğŸ‡±ğŸ‡· ğŸ‡±ğŸ‡¾ ğŸ‡±ğŸ‡® ğŸ‡±ğŸ‡¦ ğŸ‡°ğŸ‡¿ ğŸ‡°ğŸ‡ª ğŸ‡±ğŸ‡» ğŸ‡±ğŸ‡¹ ğŸ‡±ğŸ‡º ğŸ‡±ğŸ‡§ ğŸ‡°ğŸ‡® ğŸ‡½ğŸ‡° ğŸ‡±ğŸ‡¸ ğŸ‡²ğŸ‡´ ğŸ‡²ğŸ‡¹ ğŸ‡²ğŸ‡± ğŸ‡²ğŸ‡» ğŸ‡²ğŸ‡¾ ğŸ‡²ğŸ‡¼ ğŸ‡²ğŸ‡¬ ğŸ‡¹ğŸ‡· ğŸ‡¹ğŸ‡± ğŸ‡¸ğŸ‡ª ğŸ‡¸ğŸ‡© ğŸ‡¸ğŸ‡§ ğŸ‡¸ğŸ‡´ ğŸ‡°ğŸ‡·".split(" ")
